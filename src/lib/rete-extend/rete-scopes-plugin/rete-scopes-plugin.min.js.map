{"version":3,"file":"rete-scopes-plugin.min.js","sources":["src/ordering.ts","src/sizing.ts","src/scope.ts","src/utils.ts","src/presets/classic/index.ts","src/agents/classic/index.ts","src/index.ts","src/validation.ts"],"sourcesContent":["import { ConnectionId, NodeEditor, NodeId } from 'rete'\r\nimport { BaseArea, BaseAreaPlugin } from 'rete-area-plugin'\r\n\r\nimport { ExpectedScheme } from './types'\r\n\r\ntype Props<T> = {\r\n  editor: NodeEditor<ExpectedScheme>,\r\n  area: BaseAreaPlugin<ExpectedScheme, BaseArea<ExpectedScheme> | T>\r\n}\r\n\r\nfunction bringConnectionForward<T>(id: ConnectionId, props: Props<T>) {\r\n  const view = props.area.connectionViews.get(id)\r\n\r\n  if (view) {\r\n    props.area.area.content.reorder(view.element, null)\r\n  }\r\n}\r\n\r\nfunction bringConnectionBack<T>(id: ConnectionId, props: Props<T>) {\r\n  const view = props.area.connectionViews.get(id)\r\n  const { content } = props.area.area\r\n\r\n  if (view) {\r\n    content.reorder(view.element, content.holder.firstChild)\r\n  }\r\n}\r\n\r\nfunction bringForward<T>(nodeId: NodeId, props: Props<T>) {\r\n  const view = props.area.nodeViews.get(nodeId)\r\n  const connections = props.editor.getConnections().filter(c => {\r\n    return nodeId === c.source || nodeId === c.target\r\n  })\r\n  const children = props.editor.getNodes().filter(n => {\r\n    return n.parent === nodeId\r\n  })\r\n\r\n  connections.forEach(connection => bringConnectionForward(connection.id, props))\r\n\r\n  if (view) {\r\n    props.area.area.content.reorder(view.element, null)\r\n  }\r\n\r\n  children.forEach(child => bringForward(child.id, props))\r\n}\r\n\r\nexport function useOrdering<T>(props: Props<T>) {\r\n  // eslint-disable-next-line max-statements\r\n  props.area.addPipe(async context => {\r\n    if (!(context instanceof Object) || !('type' in context)) return context\r\n    if (context.type === 'nodepicked') {\r\n      bringForward(context.data.id, props)\r\n    }\r\n    if (context.type === 'connectioncreated') {\r\n      const { id } = context.data\r\n      const connection = props.editor.getConnection(id)\r\n\r\n      if (!connection) throw new Error('connection was removed')\r\n      bringConnectionBack(context.data.id, props)\r\n      bringForward(connection.source, props)\r\n      bringForward(connection.target, props)\r\n    }\r\n    return context\r\n  })\r\n}\r\n","import { NodeEditor } from 'rete'\r\nimport { BaseAreaPlugin } from 'rete-area-plugin'\r\n\r\nimport { AgentParams } from './agents/types'\r\nimport { ExpectedScheme } from './types'\r\n\r\ntype Props<T> = { editor: NodeEditor<ExpectedScheme>, area: BaseAreaPlugin<ExpectedScheme, T> }\r\n\r\nexport function getNodesBoundingBox<T>(nodes: ExpectedScheme['Node'][], { area }: Props<T>) {\r\n  const boxes = nodes.map(node => {\r\n    const view = area.nodeViews.get(node.id)\r\n\r\n    if (!view) throw new Error('view')\r\n\r\n    return {\r\n      position: view.position,\r\n      width: node.width,\r\n      height: node.height\r\n    }\r\n  })\r\n\r\n  const left = Math.min(...boxes.map(b => b.position.x))\r\n  const right = Math.max(...boxes.map(b => b.position.x + b.width))\r\n  const top = Math.min(...boxes.map(b => b.position.y))\r\n  const bottom = Math.max(...boxes.map(b => b.position.y + b.height))\r\n  const width = right - left\r\n  const height = bottom - top\r\n\r\n  return {\r\n    top,\r\n    left,\r\n    right,\r\n    bottom,\r\n    width,\r\n    height\r\n  }\r\n}\r\n\r\ntype Size = { width: number, height: number }\r\n\r\nexport function updateNodeSizes<T>(node: ExpectedScheme['Node'], size: Size, { area }: Props<T>) {\r\n  const { width, height } = size\r\n\r\n  node.width = width\r\n  node.height = height\r\n\r\n  area.resize(node.id, width, height)\r\n}\r\n\r\n// eslint-disable-next-line max-statements\r\nexport async function resizeParent<T>(parent: ExpectedScheme['Node'], agentParams: AgentParams, props: Props<T>) {\r\n  const { id } = parent\r\n  const children = props.editor.getNodes()\r\n    .filter(child => child.parent === id)\r\n    .filter(node => !agentParams.exclude(node.id))\r\n  const padding = agentParams.padding(id)\r\n\r\n  if (children.length === 0) {\r\n    const size = agentParams.size(id, {\r\n      width: padding.left + padding.right,\r\n      height: padding.top + padding.bottom\r\n    })\r\n\r\n    updateNodeSizes(parent, size, props)\r\n  } else {\r\n    const { top, left, width, height } = getNodesBoundingBox(children, props)\r\n\r\n    const outerWidth = width + padding.left + padding.right\r\n    const outerHeight = height + padding.top + padding.bottom\r\n    const outerTop = top - padding.top\r\n    const outerLeft = left - padding.left\r\n\r\n    updateNodeSizes(parent, agentParams.size(id, { width: outerWidth, height: outerHeight }), props)\r\n    await agentParams.translate(parent.id, outerLeft, outerTop)\r\n  }\r\n  if (parent.parent) {\r\n    const parentsParent = props.editor.getNode(parent.parent)\r\n\r\n    if (parentsParent) {\r\n      await resizeParent(parentsParent, agentParams, props)\r\n    }\r\n  }\r\n}\r\n","import { NodeEditor, NodeId } from 'rete'\r\nimport { BaseAreaPlugin } from 'rete-area-plugin'\r\n\r\nimport { AgentParams } from './agents/types'\r\nimport { resizeParent } from './sizing'\r\nimport { ExpectedScheme, Position } from './types'\r\n\r\ntype Props<T> = { editor: NodeEditor<ExpectedScheme>, area: BaseAreaPlugin<ExpectedScheme, T> }\r\n\r\n// eslint-disable-next-line max-statements, max-len\r\nexport async function reassignParent<T>(ids: NodeId[], pointer: { x: number, y: number }, agentParams: AgentParams, props: Props<T>) {\r\n  if (!ids.length) return\r\n  const nodes = ids\r\n    .map(id => props.editor.getNode(id))\r\n    .filter((n): n is ExpectedScheme['Node'] => Boolean(n))\r\n\r\n  const overlayNodes = props.editor.getNodes()\r\n    .filter((node) => agentParams.elder(node.id))\r\n    .map(node => {\r\n      const view = props.area.nodeViews.get(node.id)\r\n\r\n      if (!view) throw new Error('node view')\r\n\r\n      return { node, view }\r\n    }).filter(({ node, view }) => {\r\n      return !ids.includes(node.id)\r\n        && pointer.x > view.position.x\r\n        && pointer.y > view.position.y\r\n        && pointer.x < view.position.x + node.width\r\n        && pointer.y < view.position.y + node.height\r\n    })\r\n  const areaElements = Array.from(props.area.area.content.holder.childNodes)\r\n  const overlayNodesWithIndex = overlayNodes.map(({ node, view }) => {\r\n    const index = areaElements.indexOf(view.element)\r\n\r\n    return { node, view, index }\r\n  })\r\n\r\n  overlayNodesWithIndex.sort((a, b) => b.index - a.index)\r\n  const topOverlayParent = overlayNodesWithIndex[0]\r\n\r\n  const formerParents = nodes\r\n    .map(node => node.parent)\r\n    .filter((id): id is string => Boolean(id))\r\n    .map(id => {\r\n      const node = props.editor.getNode(id)\r\n\r\n      if (!node) throw new Error('node')\r\n\r\n      return node\r\n    })\r\n\r\n  // eslint-disable-next-line no-undefined\r\n  nodes.forEach(node => node.parent = undefined)\r\n  if (topOverlayParent) {\r\n    nodes.forEach(node => node.parent = topOverlayParent.node.id)\r\n    await resizeParent(topOverlayParent.node, agentParams, props)\r\n  }\r\n\r\n  for (const formerParent of formerParents) {\r\n    await resizeParent(formerParent, agentParams, props)\r\n  }\r\n}\r\n\r\nexport async function translateChildren<T>(\r\n  id: NodeId,\r\n  { position, previous }: { position: Position, previous: Position },\r\n  props: Props<T>\r\n) {\r\n  const children = props.editor.getNodes().filter(n => n.parent === id)\r\n\r\n  await Promise.all(children.map(async n => {\r\n    const dx = position.x - previous.x\r\n    const dy = position.y - previous.y\r\n\r\n    const view = props.area.nodeViews.get(n.id)\r\n    const node = props.editor.getNode(n.id)\r\n\r\n    if (view && node && !node.selected) {\r\n      const nodePosition = view.position\r\n\r\n      await view.translate(nodePosition.x + dx, nodePosition.y + dy)\r\n    }\r\n  }))\r\n}\r\n","import { BaseSchemes, NodeEditor, NodeId } from 'rete'\r\nimport { BaseAreaPlugin } from 'rete-area-plugin'\r\n\r\nimport { ExpectedScheme } from './types'\r\n\r\ntype Props<T> = { editor: NodeEditor<ExpectedScheme>, area: BaseAreaPlugin<ExpectedScheme, T> }\r\n\r\nexport function belongsTo<T>(nodeId: NodeId, ids: NodeId[], props: Props<T>) {\r\n  const node = props.editor.getNode(nodeId)\r\n\r\n  if (!node) throw new Error('node')\r\n\r\n  if (ids.includes(nodeId)) return true\r\n  if (!node.parent) return false\r\n  if (belongsTo(node.parent, ids, props)) return true\r\n}\r\n\r\nexport function hasSelectedParent<T>(nodeId: NodeId, props: Props<T>): boolean {\r\n  const node = props.editor.getNode(nodeId)\r\n\r\n  if (!node) throw new Error('node')\r\n\r\n  if (!node.parent) return false\r\n\r\n  const parent = props.editor.getNode(node.parent)\r\n\r\n  if (!parent) throw new Error('node')\r\n\r\n  if (parent.selected) return true\r\n\r\n  return hasSelectedParent(node.parent, props)\r\n}\r\n\r\nexport type Translate = (nodeId: string, x: number, y: number) => Promise<void>\r\n\r\n/**\r\n * keep track of currently moving nodes (to prevent infinite loop)\r\n */\r\nexport function trackedTranslate<T>(props: Props<T>): {\r\n  translate: Translate,\r\n  isTranslating: (id: NodeId) => boolean\r\n} {\r\n  const active = new Map<NodeId, number>()\r\n  const increment = (id: NodeId) => active.set(id, (active.get(id) || 0) + 1)\r\n  const decrement = (id: NodeId) => active.set(id, (active.get(id) || 0) - 1)\r\n\r\n  return {\r\n    async translate(id, x, y) {\r\n      const view = props.area.nodeViews.get(id)\r\n\r\n      if (!view) throw new Error('cannot find parent node view')\r\n\r\n      const previous = view.position\r\n\r\n      if (previous.x !== x || previous.y !== y) {\r\n        increment(id)\r\n        await view.translate(x, y)\r\n        decrement(id)\r\n      }\r\n    },\r\n    isTranslating(id) {\r\n      return (active.get(id) || 0) > 0\r\n    }\r\n  }\r\n}\r\n\r\nexport function watchClearing(editor: NodeEditor<BaseSchemes>) {\r\n  let state = false\r\n\r\n  editor.addPipe(context => {\r\n    if (context.type === 'clear') {\r\n      state = true\r\n    }\r\n    if (context.type === 'cleared' || context.type === 'clearcancelled') {\r\n      state = false\r\n    }\r\n    return context\r\n  })\r\n\r\n  return () => state\r\n}\r\n","import { classic } from '../../agents'\r\nimport { Preset } from '../types'\r\n\r\n/**\r\n * Classic preset allowing capturing a node by long-pressing it and dropping it onto another node to make it a nested.\r\n * @returns Preset\r\n * @listens nodepicked\r\n * @listens nodetranslated\r\n * @listens nodedragged\r\n * @emits scopepicked\r\n * @emits scopereleased\r\n */\r\nexport function setup(): Preset {\r\n  return (params, context) => {\r\n    classic.useScopeAgent(params, context)\r\n    classic.useVisualEffects(params, context)\r\n  }\r\n}\r\n","import { NodeId } from 'rete'\r\n\r\nimport { getPickedNodes } from '../..'\r\nimport { reassignParent } from '../../scope'\r\nimport { Position } from '../../types'\r\nimport { AgentContext, AgentParams, ScopeAgent } from '../types'\r\n\r\nexport type DefaultScopesAgentParams = AgentParams & {\r\n  timeout?: number\r\n}\r\n\r\nexport const useScopeAgent: ScopeAgent = (params: DefaultScopesAgentParams, { area, editor, scopes }) => {\r\n  const timeout = params.timeout || 250\r\n\r\n  let picked: { timeout: number } | null = null\r\n  let candidates: string[] = []\r\n\r\n  function cancel() {\r\n    if (picked) {\r\n      window.clearTimeout(picked.timeout)\r\n      picked = null\r\n    }\r\n  }\r\n\r\n  function pick(id: NodeId) {\r\n    const timeoutId = window.setTimeout(() => {\r\n      const selected = editor.getNodes().filter(n => n.selected)\r\n      const targets = selected.length ? selected.map(n => n.id) : [id]\r\n\r\n      candidates.push(...targets)\r\n      scopes.emit({ type: 'scopepicked', data: { ids: targets } })\r\n    }, timeout)\r\n\r\n    picked = { timeout: timeoutId }\r\n  }\r\n  function release() {\r\n    const list = [...candidates]\r\n\r\n    cancel()\r\n    candidates = []\r\n\r\n    scopes.emit({ type: 'scopereleased', data: { ids: list } })\r\n\r\n    return list\r\n  }\r\n\r\n  area.addPipe(async context => {\r\n    if (!(context instanceof Object) || !('type' in context)) return context\r\n    if (context.type === 'nodepicked') {\r\n      pick(context.data.id)\r\n    }\r\n    if (context.type === 'nodetranslated') {\r\n      cancel()\r\n    }\r\n    if (context.type === 'nodedragged') {\r\n      const { pointer } = area.area\r\n      const ids = release()\r\n\r\n      if (ids.length === 0) return\r\n\r\n      await reassignParent(ids, pointer, params, { area, editor })\r\n    }\r\n    return context\r\n  })\r\n}\r\n\r\nexport function useVisualEffects<T>(params: DefaultScopesAgentParams, { area, editor, scopes }: AgentContext<T>): void {\r\n  const pickedNodes = getPickedNodes(scopes)\r\n  let previousHighlighted: string | null = null\r\n  let clientPointerPostion: Position | null = null\r\n\r\n  // eslint-disable-next-line max-statements\r\n  function updateHighlightedScopes(position: { x: number, y: number }, nodes: NodeId[]) {\r\n    // 如果先前有高亮对象，先取消其高亮\r\n    if (previousHighlighted) {\r\n      const view = area.nodeViews.get(previousHighlighted)\r\n\r\n      if (view && nodes.length) view.element.style.opacity = '0.4'\r\n      previousHighlighted = null\r\n    }\r\n    if (nodes.length) {\r\n      const { x, y } = position\r\n      const elements = document.elementsFromPoint(x, y)\r\n      const nodeViews = editor.getNodes().filter(node => {\r\n        return params.elder(node.id)\r\n      }).map(node => {\r\n        const view = area.nodeViews.get(node.id)\r\n\r\n        if (!view) throw new Error('view')\r\n\r\n        return {\r\n          node,\r\n          view\r\n        }\r\n      })\r\n\r\n      const intersectedNodes = elements\r\n        .map(el => nodeViews.find(item => item.view.element === el))\r\n        .filter((item): item is Exclude<typeof item, undefined> => Boolean(item))\r\n\r\n      const nonSelected = intersectedNodes\r\n        .filter(item => !item.node.selected)\r\n      // 从交互点出发，找到画布中交互点位置上的节点们，然后和画布中记录的节点做比对，找出交叉内容，之后剔除选中（正在拖拽的）的内容后，第一个交互点就是会进行拖入操作的。\r\n      const first = nonSelected[0]\r\n\r\n      if (first) {\r\n        first.view.element.style.opacity = '0.8'\r\n        previousHighlighted = first.node.id\r\n      }\r\n    }\r\n  }\r\n  // eslint-disable-next-line max-statements\r\n  scopes.addPipe(context => {\r\n    if (context.type === 'scopepicked') {\r\n      const { ids } = context.data\r\n\r\n      // 未选中的节点统统改为虚化（opacity=0.4)\r\n      editor.getNodes().filter(n => !ids.includes(n.id)).forEach(node => {\r\n        const view = area.nodeViews.get(node.id)\r\n\r\n        if (view) view.element.style.opacity = '0.4'\r\n      })\r\n      if (clientPointerPostion) {\r\n        updateHighlightedScopes(clientPointerPostion, pickedNodes)\r\n      }\r\n    }\r\n    if (context.type === 'scopereleased') {\r\n      const { ids } = context.data\r\n\r\n      // 未选中的节点统统解除虚化（opacity='')\r\n      editor.getNodes().filter(n => !ids.includes(n.id)).forEach(node => {\r\n        const view = area.nodeViews.get(node.id)\r\n\r\n        if (view) view.element.style.opacity = ''\r\n      })\r\n      if (clientPointerPostion) {\r\n        updateHighlightedScopes(clientPointerPostion, pickedNodes)\r\n      }\r\n    }\r\n    if (context.type === 'pointermove') {\r\n      clientPointerPostion = {\r\n        x: context.data.event.clientX,\r\n        y: context.data.event.clientY\r\n      }\r\n      updateHighlightedScopes(clientPointerPostion, pickedNodes)\r\n    }\r\n    return context\r\n  })\r\n}\r\n","import { NodeEditor, NodeId, Root, Scope } from 'rete'\r\nimport { BaseArea, BaseAreaPlugin } from 'rete-area-plugin'\r\n\r\nimport { useOrdering } from './ordering'\r\nimport { Preset } from './presets/types'\r\nimport { translateChildren } from './scope'\r\nimport { resizeParent } from './sizing'\r\nimport { ExpectedScheme, Padding, Size } from './types'\r\nimport { belongsTo, hasSelectedParent, trackedTranslate } from './utils'\r\nimport { useValidator } from './validation'\r\n\r\nexport * as Presets from './presets'\r\n\r\n/**\r\n * Props for `ScopesPlugin` class.\r\n */\r\nexport type Props = {\r\n  /** Padding (space) between the scope's border and its children. Default is `() => ({ top: 40, left: 20, right: 20, bottom: 20 })` */\r\n  padding?: (id: NodeId) => Padding\r\n  /** Determines whether the nested node should be excluded from affecting the scope's size, etc. Default is `() => false` */\r\n  exclude?: (id: NodeId) => boolean\r\n  /** Customizes the size of the node which is recognized as a parent. Default is `(id, size) => size` */\r\n  size?: (id: NodeId, size: Size) => Size\r\n  /** 决定这个目标节点是否具备父级能力 */\r\n  elder?: (id: NodeId) => boolean\r\n}\r\n\r\ntype Requires<Schemes extends ExpectedScheme> =\r\n  | BaseArea<Schemes>\r\n\r\n/**\r\n * Signal types produced by ConnectionPlugin instance\r\n * @priority 10\r\n */\r\nexport type Scopes =\r\n  | { type: 'scopepicked', data: { ids: NodeId[] } }\r\n  | { type: 'scopereleased', data: { ids: NodeId[] } }\r\n\r\n/**\r\n * Scope plugin. Responsible for user interaction with scopes (nested nodes, groups)\r\n * @priority 9\r\n * @listens nodetranslated\r\n * @listens noderemoved\r\n * @emits scopepicked\r\n * @emits scopereleased\r\n */\r\nexport class ScopesPlugin<\r\n  Schemes extends ExpectedScheme, T = never\r\n> extends Scope<Scopes, [Requires<Schemes>, Root<Schemes>]> {\r\n  padding: (id: NodeId) => Padding\r\n  exclude: (id: NodeId) => boolean\r\n  elder: (id: NodeId) => boolean\r\n  size: (id: NodeId, size: Size) => Size\r\n  editor!: NodeEditor<Schemes>\r\n  area!: BaseAreaPlugin<Schemes, T>\r\n  presets: Preset[] = []\r\n\r\n  constructor(props?: Props) {\r\n    super('scopes')\r\n    this.padding = props?.padding || (() => ({\r\n      top: 40,\r\n      left: 20,\r\n      right: 20,\r\n      bottom: 20\r\n    }))\r\n    this.exclude = props?.exclude || (() => false)\r\n    this.size = props?.size || ((id, size) => size)\r\n    this.elder = props?.elder || (() => true)\r\n  }\r\n\r\n  // eslint-disable-next-line max-statements\r\n  setParent(scope: Scope<BaseArea<Schemes>, [Root<Schemes>]>): void {\r\n    super.setParent(scope)\r\n\r\n    this.area = this.parentScope<BaseAreaPlugin<Schemes, T>>(BaseAreaPlugin)\r\n    this.editor = this.area.parentScope<NodeEditor<Schemes>>(NodeEditor)\r\n\r\n    const props = { editor: this.editor, area: this.area }\r\n    const { padding, size, exclude, elder } = this\r\n    const pickedNodes = getPickedNodes(this)\r\n    const { translate, isTranslating } = trackedTranslate(props)\r\n    const agentParams = { padding, size, exclude, elder, translate }\r\n\r\n    useValidator(props)\r\n    useOrdering(props)\r\n\r\n    this.presets.forEach(preset => {\r\n      preset(agentParams, { ...props, scopes: this })\r\n    })\r\n\r\n    // eslint-disable-next-line max-statements, complexity\r\n    this.addPipe(async context => {\r\n      if (context.type === 'nodetranslated') {\r\n        const { id } = context.data\r\n        const current = props.editor.getNode(id)\r\n\r\n        if (!current) throw new Error('cannot find node')\r\n        // prevent translating children if the node translation\r\n        // is triggered by its resizing (when its children moved)\r\n        if (!isTranslating(id)) {\r\n          await translateChildren(id, context.data, props)\r\n        }\r\n\r\n        const parent = current.parent ? props.editor.getNode(current.parent) : null\r\n\r\n        if (parent && !agentParams.exclude(id)) {\r\n          const hasAnySelectedParent = hasSelectedParent(id, props)\r\n          const isPicked = belongsTo(current.id, pickedNodes, props)\r\n\r\n          if (!hasAnySelectedParent && !isPicked) {\r\n            await resizeParent(parent, agentParams, props)\r\n          }\r\n        }\r\n      }\r\n      if (context.type === 'noderemoved') {\r\n        const parentId = context.data.parent\r\n        const parent = parentId && props.editor.getNode(parentId)\r\n\r\n        if (parent) {\r\n          await resizeParent(parent, agentParams, props)\r\n        }\r\n      }\r\n      return context\r\n    })\r\n  }\r\n\r\n  /**\r\n   * Adds a preset to the plugin.\r\n   * @param preset Preset that is responsible for user interactions with scopes (e.g. assigning nodes to scopes)\r\n   */\r\n  public addPreset(preset: Preset) {\r\n    this.presets.push(preset)\r\n  }\r\n\r\n  public isDependent(id: NodeId) {\r\n    const props = { editor: this.editor, area: this.area }\r\n    const node = this.editor.getNode(id)\r\n\r\n    return node && (node.selected || hasSelectedParent(id, props))\r\n  }\r\n}\r\n\r\nexport function getPickedNodes<S extends ExpectedScheme>(scopes: Scope<Scopes, [Requires<S>, Root<S>]>) {\r\n  const nodes: NodeId[] = []\r\n\r\n  scopes.addPipe(async context => {\r\n    if (!('type' in context)) return context\r\n    if (context.type === 'scopepicked') {\r\n      nodes.push(...context.data.ids)\r\n    }\r\n    if (context.type === 'scopereleased') {\r\n      nodes.splice(0, nodes.length, ...nodes.filter(id => !context.data.ids.includes(id)))\r\n    }\r\n    return context\r\n  })\r\n  return nodes\r\n}\r\n","import { NodeEditor } from 'rete'\r\nimport { BaseAreaPlugin } from 'rete-area-plugin'\r\n\r\nimport { ExpectedScheme } from './types'\r\nimport { watchClearing } from './utils'\r\n\r\ntype Props<T> = { editor: NodeEditor<ExpectedScheme>, area: BaseAreaPlugin<ExpectedScheme, T> }\r\n\r\nexport function useValidator<T>(props: Props<T>) {\r\n  const isClearing = watchClearing(props.editor)\r\n\r\n  // eslint-disable-next-line max-statements\r\n  props.area.addPipe(context => {\r\n    if (!context || !(typeof context === 'object' && 'type' in context)) return context\r\n    if (context.type === 'nodecreate') {\r\n      const parentId = context.data.parent\r\n\r\n      if (parentId) {\r\n        const parent = props.editor.getNodes().find(n => n.id === parentId)\r\n\r\n        if (!parent) throw new Error('parent node doesnt exist')\r\n      }\r\n    }\r\n    if (context.type === 'noderemove' && !isClearing()) {\r\n      const { id } = context.data\r\n\r\n      const child = props.editor.getNodes().find(n => n.parent === id)\r\n\r\n      if (child) throw new Error('cannot remove parent node with a children')\r\n    }\r\n    return context\r\n  })\r\n}\r\n"],"names":["bringConnectionBack","id","props","view","area","connectionViews","get","content","reorder","element","holder","firstChild","bringForward","nodeId","nodeViews","connections","editor","getConnections","filter","c","source","target","children","getNodes","n","parent","forEach","connection","bringConnectionForward","child","getNodesBoundingBox","nodes","_ref","boxes","map","node","Error","position","width","height","left","Math","min","apply","_toConsumableArray","b","x","right","max","top","y","bottom","updateNodeSizes","size","_ref2","resize","resizeParent","_x","_x2","_x3","_resizeParent","this","arguments","_asyncToGenerator","_regeneratorRuntime","mark","_callee","agentParams","padding","_getNodesBoundingBox","outerWidth","outerHeight","outerTop","outerLeft","parentsParent","wrap","_context","prev","next","exclude","length","translate","getNode","stop","reassignParent","_x4","_reassignParent","ids","pointer","overlayNodes","areaElements","overlayNodesWithIndex","topOverlayParent","formerParents","_iterator","_step","formerParent","abrupt","Boolean","elder","includes","Array","from","childNodes","_ref3","index","indexOf","sort","a","undefined","_createForOfIteratorHelper","s","done","value","t0","e","f","finish","translateChildren","_x5","_x6","_x7","_translateChildren","_callee3","previous","_context3","Promise","all","_ref4","_callee2","dx","dy","nodePosition","_context2","selected","_x8","belongsTo","hasSelectedParent","params","context","scopes","timeout","picked","candidates","cancel","window","clearTimeout","pick","timeoutId","setTimeout","_candidates","targets","push","emit","type","data","addPipe","Object","list","classic","pickedNodes","getPickedNodes","previousHighlighted","clientPointerPostion","updateHighlightedScopes","style","opacity","elements","document","elementsFromPoint","first","el","find","item","event","clientX","clientY","ScopesPlugin","_Scope","_this","_classCallCheck","_defineProperty","_callSuper","_inherits","key","scope","_this2","_get","_getPrototypeOf","prototype","call","parentScope","BaseAreaPlugin","NodeEditor","_trackedTranslate","active","Map","increment","set","decrement","isTranslating","trackedTranslate","state","isClearing","_typeof","parentId","useValidator","getConnection","useOrdering","presets","preset","_objectSpread","_id","current","hasAnySelectedParent","isPicked","_parent","Scope","splice","concat"],"mappings":";;;;;w2VAkBA,SAASA,EAAuBC,EAAkBC,GAChD,IAAMC,EAAOD,EAAME,KAAKC,gBAAgBC,IAAIL,GACpCM,EAAYL,EAAME,KAAKA,KAAvBG,QAEJJ,GACFI,EAAQC,QAAQL,EAAKM,QAASF,EAAQG,OAAOC,WAEjD,CAEA,SAASC,EAAgBC,EAAgBX,GACvC,IAAMC,EAAOD,EAAME,KAAKU,UAAUR,IAAIO,GAChCE,EAAcb,EAAMc,OAAOC,iBAAiBC,QAAO,SAAAC,GACvD,OAAON,IAAWM,EAAEC,QAAUP,IAAWM,EAAEE,MAC7C,IACMC,EAAWpB,EAAMc,OAAOO,WAAWL,QAAO,SAAAM,GAC9C,OAAOA,EAAEC,SAAWZ,CACtB,IAEAE,EAAYW,SAAQ,SAAAC,GAAU,OA1BhC,SAAmC1B,EAAkBC,GACnD,IAAMC,EAAOD,EAAME,KAAKC,gBAAgBC,IAAIL,GAExCE,GACFD,EAAME,KAAKA,KAAKG,QAAQC,QAAQL,EAAKM,QAAS,KAElD,CAoBoCmB,CAAuBD,EAAW1B,GAAIC,MAEpEC,GACFD,EAAME,KAAKA,KAAKG,QAAQC,QAAQL,EAAKM,QAAS,MAGhDa,EAASI,SAAQ,SAAAG,GAAK,OAAIjB,EAAaiB,EAAM5B,GAAIC,KACnD,CCnCO,SAAS4B,EAAuBC,EAA+BC,GAAsB,IAAlB5B,EAAI4B,EAAJ5B,KAClE6B,EAAQF,EAAMG,KAAI,SAAAC,GACtB,IAAMhC,EAAOC,EAAKU,UAAUR,IAAI6B,EAAKlC,IAErC,IAAKE,EAAM,MAAM,IAAIiC,MAAM,QAE3B,MAAO,CACLC,SAAUlC,EAAKkC,SACfC,MAAOH,EAAKG,MACZC,OAAQJ,EAAKI,OAEjB,IAEMC,EAAOC,KAAKC,IAAGC,MAARF,KAAIG,EAAQX,EAAMC,KAAI,SAAAW,GAAC,OAAIA,EAAER,SAASS,CAAC,MAC9CC,EAAQN,KAAKO,IAAGL,MAARF,KAAIG,EAAQX,EAAMC,KAAI,SAAAW,GAAC,OAAIA,EAAER,SAASS,EAAID,EAAEP,KAAK,MACzDW,EAAMR,KAAKC,IAAGC,MAARF,KAAIG,EAAQX,EAAMC,KAAI,SAAAW,GAAC,OAAIA,EAAER,SAASa,CAAC,MAC7CC,EAASV,KAAKO,IAAGL,MAARF,KAAIG,EAAQX,EAAMC,KAAI,SAAAW,GAAC,OAAIA,EAAER,SAASa,EAAIL,EAAEN,MAAM,MAIjE,MAAO,CACLU,IAAAA,EACAT,KAAAA,EACAO,MAAAA,EACAI,OAAAA,EACAb,MARYS,EAAQP,EASpBD,OARaY,EAASF,EAU1B,CAIO,SAASG,EAAmBjB,EAA8BkB,EAAUC,GAAsB,IAAlBlD,EAAIkD,EAAJlD,KACrEkC,EAAkBe,EAAlBf,MAAOC,EAAWc,EAAXd,OAEfJ,EAAKG,MAAQA,EACbH,EAAKI,OAASA,EAEdnC,EAAKmD,OAAOpB,EAAKlC,GAAIqC,EAAOC,EAC9B,CAGA,SAAsBiB,EAAYC,EAAAC,EAAAC,GAAA,OAAAC,EAAAjB,MAAAkB,KAAAC,UAAA,CAgCjC,SAAAF,IAAA,OAAAA,EAAAG,EAAAC,IAAAC,MAhCM,SAAAC,EAA+BzC,EAAgC0C,EAA0BjE,GAAe,IAAAD,EAAAqB,EAAA8C,EAAAf,EAAAgB,EAAApB,EAAAT,EAAAF,EAAAC,EAAA+B,EAAAC,EAAAC,EAAAC,EAAAC,EAAA,OAAAV,IAAAW,MAAA,SAAAC,GAAA,cAAAA,EAAAC,KAAAD,EAAAE,MAAA,KAAA,EAKtE,GAJ/B7E,EAAOwB,EAAPxB,GACFqB,EAAWpB,EAAMc,OAAOO,WAC3BL,QAAO,SAAAW,GAAK,OAAIA,EAAMJ,SAAWxB,CAAE,IACnCiB,QAAO,SAAAiB,GAAI,OAAKgC,EAAYY,QAAQ5C,EAAKlC,OACtCmE,EAAUD,EAAYC,QAAQnE,GAEZ,IAApBqB,EAAS0D,OAAY,CAAAJ,EAAAE,KAAA,EAAA,KAAA,CACjBzB,EAAOc,EAAYd,KAAKpD,EAAI,CAChCqC,MAAO8B,EAAQ5B,KAAO4B,EAAQrB,MAC9BR,OAAQ6B,EAAQnB,IAAMmB,EAAQjB,SAGhCC,EAAgB3B,EAAQ4B,EAAMnD,GAAM0E,EAAAE,KAAA,GAAA,MAAA,KAAA,EAS4D,OAT5DT,EAECvC,EAAoBR,EAAUpB,GAA3D+C,EAAGoB,EAAHpB,IAAKT,EAAI6B,EAAJ7B,KAAMF,EAAK+B,EAAL/B,MAAOC,EAAM8B,EAAN9B,OAEpB+B,EAAahC,EAAQ8B,EAAQ5B,KAAO4B,EAAQrB,MAC5CwB,EAAchC,EAAS6B,EAAQnB,IAAMmB,EAAQjB,OAC7CqB,EAAWvB,EAAMmB,EAAQnB,IACzBwB,EAAYjC,EAAO4B,EAAQ5B,KAEjCY,EAAgB3B,EAAQ0C,EAAYd,KAAKpD,EAAI,CAAEqC,MAAOgC,EAAY/B,OAAQgC,IAAgBrE,GAAM0E,EAAAE,KAAA,GAC1FX,EAAYc,UAAUxD,EAAOxB,GAAIwE,EAAWD,GAAS,KAAA,GAAA,IAEzD/C,EAAOA,OAAM,CAAAmD,EAAAE,KAAA,GAAA,KAAA,CAC0C,KAAnDJ,EAAgBxE,EAAMc,OAAOkE,QAAQzD,EAAOA,SAEjC,CAAAmD,EAAAE,KAAA,GAAA,KAAA,CAAA,OAAAF,EAAAE,KAAA,GACTtB,EAAakB,EAAeP,EAAajE,GAAM,KAAA,GAAA,IAAA,MAAA,OAAA0E,EAAAO,OAAA,GAAAjB,EAG1D,MAAAvB,MAAAkB,KAAAC,UAAA,CCxEqBsB,SAAAA,EAAc3B,EAAAC,EAAAC,EAAA0B,GAAA,OAAAC,EAAA3C,MAAAkB,KAAAC,UAAA,CAoDnC,SAAAwB,IAAA,OAAAA,EAAAvB,EAAAC,IAAAC,MApDM,SAAAC,EAAiCqB,EAAeC,EAAmCrB,EAA0BjE,GAAe,IAAA6B,EAAA0D,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAA,OAAAhC,IAAAW,MAAA,SAAAC,GAAA,cAAAA,EAAAC,KAAAD,EAAAE,MAAA,KAAA,EAAA,GAC5HS,EAAIP,OAAM,CAAAJ,EAAAE,KAAA,EAAA,KAAA,CAAA,OAAAF,EAAAqB,OAAA,UAAA,KAAA,EA0C+B,GAzCxClE,EAAQwD,EACXrD,KAAI,SAAAjC,GAAE,OAAIC,EAAMc,OAAOkE,QAAQjF,EAAG,IAClCiB,QAAO,SAACM,GAAC,OAAkC0E,QAAQ1E,MAEhDiE,EAAevF,EAAMc,OAAOO,WAC/BL,QAAO,SAACiB,GAAI,OAAKgC,EAAYgC,MAAMhE,EAAKlC,GAAG,IAC3CiC,KAAI,SAAAC,GACH,IAAMhC,EAAOD,EAAME,KAAKU,UAAUR,IAAI6B,EAAKlC,IAE3C,IAAKE,EAAM,MAAM,IAAIiC,MAAM,aAE3B,MAAO,CAAED,KAAAA,EAAMhC,KAAAA,EACjB,IAAGe,QAAO,SAAAoC,GAAoB,IAAjBnB,EAAImB,EAAJnB,KAAMhC,EAAImD,EAAJnD,KACjB,OAAQoF,EAAIa,SAASjE,EAAKlC,KACrBuF,EAAQ1C,EAAI3C,EAAKkC,SAASS,GAC1B0C,EAAQtC,EAAI/C,EAAKkC,SAASa,GAC1BsC,EAAQ1C,EAAI3C,EAAKkC,SAASS,EAAIX,EAAKG,OACnCkD,EAAQtC,EAAI/C,EAAKkC,SAASa,EAAIf,EAAKI,MAC1C,IACImD,EAAeW,MAAMC,KAAKpG,EAAME,KAAKA,KAAKG,QAAQG,OAAO6F,aACzDZ,EAAwBF,EAAavD,KAAI,SAAAsE,GAAoB,IAAjBrE,EAAIqE,EAAJrE,KAAMhC,EAAIqG,EAAJrG,KAGtD,MAAO,CAAEgC,KAAAA,EAAMhC,KAAAA,EAAMsG,MAFPf,EAAagB,QAAQvG,EAAKM,SAG1C,KAEsBkG,MAAK,SAACC,EAAG/D,GAAC,OAAKA,EAAE4D,MAAQG,EAAEH,SAC3Cb,EAAmBD,EAAsB,GAEzCE,EAAgB9D,EACnBG,KAAI,SAAAC,GAAI,OAAIA,EAAKV,MAAM,IACvBP,QAAO,SAACjB,GAAE,OAAmBiG,QAAQjG,EAAG,IACxCiC,KAAI,SAAAjC,GACH,IAAMkC,EAAOjC,EAAMc,OAAOkE,QAAQjF,GAElC,IAAKkC,EAAM,MAAM,IAAIC,MAAM,QAE3B,OAAOD,CACT,IAGFJ,EAAML,SAAQ,SAAAS,GAAI,OAAIA,EAAKV,YAASoF,MAChCjB,EAAgB,CAAAhB,EAAAE,KAAA,GAAA,KAAA,CAC2C,OAA7D/C,EAAML,SAAQ,SAAAS,GAAI,OAAIA,EAAKV,OAASmE,EAAiBzD,KAAKlC,MAAG2E,EAAAE,KAAA,GACvDtB,EAAaoC,EAAiBzD,KAAMgC,EAAajE,GAAM,KAAA,GAAA4F,EAAAgB,EAGpCjB,GAAajB,EAAAC,KAAA,GAAAiB,EAAAiB,IAAA,KAAA,GAAA,IAAAhB,EAAAD,EAAAtE,KAAAwF,KAAA,CAAApC,EAAAE,KAAA,GAAA,KAAA,CAAjB,OAAZkB,EAAYD,EAAAkB,MAAArC,EAAAE,KAAA,GACftB,EAAawC,EAAc7B,EAAajE,GAAM,KAAA,GAAA0E,EAAAE,KAAA,GAAA,MAAA,KAAA,GAAAF,EAAAE,KAAA,GAAA,MAAA,KAAA,GAAAF,EAAAC,KAAA,GAAAD,EAAAsC,GAAAtC,EAAA,MAAA,IAAAkB,EAAAqB,EAAAvC,EAAAsC,IAAA,KAAA,GAAA,OAAAtC,EAAAC,KAAA,GAAAiB,EAAAsB,IAAAxC,EAAAyC,OAAA,IAAA,KAAA,GAAA,IAAA,MAAA,OAAAzC,EAAAO,OAAA,GAAAjB,EAAA,KAAA,CAAA,CAAA,GAAA,GAAA,GAAA,KAEvD,MAAAvB,MAAAkB,KAAAC,UAAA,CAED,SAAsBwD,EAAiBC,EAAAC,EAAAC,GAAA,OAAAC,EAAA/E,MAAAkB,KAAAC,UAAA,CAoBtC,SAAA4D,IAAA,OAAAA,EAAA3D,EAAAC,IAAAC,MApBM,SAAA0D,EACL1H,EAAU+B,EAEV9B,GAAe,IAAAmC,EAAAuF,EAAAtG,EAAA,OAAA0C,IAAAW,MAAA,SAAAkD,GAAA,cAAAA,EAAAhD,KAAAgD,EAAA/C,MAAA,KAAA,EAEsD,OAHnEzC,EAAQL,EAARK,SAAUuF,EAAQ5F,EAAR4F,SAGNtG,EAAWpB,EAAMc,OAAOO,WAAWL,QAAO,SAAAM,GAAC,OAAIA,EAAEC,SAAWxB,KAAG4H,EAAA/C,KAAA,EAE/DgD,QAAQC,IAAIzG,EAASY,IAAG,WAAA,IAAA8F,EAAAjE,EAAAC,IAAAC,MAAC,SAAAgE,EAAMzG,GAAC,IAAA0G,EAAAC,EAAAhI,EAAAgC,EAAAiG,EAAA,OAAApE,IAAAW,MAAA,SAAA0D,GAAA,cAAAA,EAAAxD,KAAAwD,EAAAvD,MAAA,KAAA,EAKG,GAJjCoD,EAAK7F,EAASS,EAAI8E,EAAS9E,EAC3BqF,EAAK9F,EAASa,EAAI0E,EAAS1E,EAE3B/C,EAAOD,EAAME,KAAKU,UAAUR,IAAIkB,EAAEvB,IAClCkC,EAAOjC,EAAMc,OAAOkE,QAAQ1D,EAAEvB,KAEhCE,IAAQgC,GAASA,EAAKmG,SAAQ,CAAAD,EAAAvD,KAAA,EAAA,KAAA,CACE,OAA5BsD,EAAejI,EAAKkC,SAAQgG,EAAAvD,KAAA,EAE5B3E,EAAK8E,UAAUmD,EAAatF,EAAIoF,EAAIE,EAAalF,EAAIiF,GAAG,KAAA,EAAA,IAAA,MAAA,OAAAE,EAAAlD,OAAA,GAAA8C,EAEjE,KAAA,OAAA,SAAAM,GAAA,OAAAP,EAAArF,MAAAkB,KAAAC,UAAA,CAAA,CAZ6B,KAY3B,KAAA,EAAA,IAAA,MAAA,OAAA+D,EAAA1C,OAAA,GAAAwC,EACJ,KAAAD,EAAA/E,MAAAkB,KAAAC,UAAA,CC7EM,SAAS0E,EAAa3H,EAAgB0E,EAAerF,GAC1D,IAAMiC,EAAOjC,EAAMc,OAAOkE,QAAQrE,GAElC,IAAKsB,EAAM,MAAM,IAAIC,MAAM,QAE3B,QAAImD,EAAIa,SAASvF,MACZsB,EAAKV,WACN+G,EAAUrG,EAAKV,OAAQ8D,EAAKrF,SAAhC,EACF,CAEO,SAASuI,EAAqB5H,EAAgBX,GACnD,IAAMiC,EAAOjC,EAAMc,OAAOkE,QAAQrE,GAElC,IAAKsB,EAAM,MAAM,IAAIC,MAAM,QAE3B,IAAKD,EAAKV,OAAQ,OAAO,EAEzB,IAAMA,EAASvB,EAAMc,OAAOkE,QAAQ/C,EAAKV,QAEzC,IAAKA,EAAQ,MAAM,IAAIW,MAAM,QAE7B,QAAIX,EAAO6G,UAEJG,EAAkBtG,EAAKV,OAAQvB,EACxC,2CCnBO,WACL,OAAO,SAACwI,EAAQC,ICFuB,SAACD,EAAgC1G,GAA+B,IAA3B5B,EAAI4B,EAAJ5B,KAAMY,EAAMgB,EAANhB,OAAQ4H,EAAM5G,EAAN4G,OACpFC,EAAUH,EAAOG,SAAW,IAE9BC,EAAqC,KACrCC,EAAuB,GAE3B,SAASC,IACHF,IACFG,OAAOC,aAAaJ,EAAOD,SAC3BC,EAAS,KAEb,CAEA,SAASK,EAAKlJ,GACZ,IAAMmJ,EAAYH,OAAOI,YAAW,WAAM,IAAAC,EAClChB,EAAWtH,EAAOO,WAAWL,QAAO,SAAAM,GAAC,OAAIA,EAAE8G,YAC3CiB,EAAUjB,EAAStD,OAASsD,EAASpG,KAAI,SAAAV,GAAC,OAAIA,EAAEvB,MAAM,CAACA,IAE7DqJ,EAAAP,GAAWS,KAAI7G,MAAA2G,EAAA1G,EAAI2G,IACnBX,EAAOa,KAAK,CAAEC,KAAM,cAAeC,KAAM,CAAEpE,IAAKgE,IACjD,GAAEV,GAEHC,EAAS,CAAED,QAASO,EACtB,CAYAhJ,EAAKwJ,QAAO,WAAA,IAAAtG,EAAAS,EAAAC,IAAAC,MAAC,SAAAC,EAAMyE,GAAO,IAAAnD,EAAAD,EAAA,OAAAvB,IAAAW,MAAA,SAAAC,GAAA,cAAAA,EAAAC,KAAAD,EAAAE,MAAA,KAAA,EAAA,GAClB6D,aAAmBkB,QAAa,SAAUlB,EAAQ,CAAA/D,EAAAE,KAAA,EAAA,KAAA,CAAA,OAAAF,EAAAqB,OAAA,SAAS0C,GAAO,KAAA,EAMvE,GALoB,eAAjBA,EAAQe,MACVP,EAAKR,EAAQgB,KAAK1J,IAEC,mBAAjB0I,EAAQe,MACVV,IAEmB,gBAAjBL,EAAQe,KAAsB,CAAA9E,EAAAE,KAAA,GAAA,KAAA,CAEX,GADbU,EAAYpF,EAAKA,KAAjBoF,QAnBJsE,WAAIlH,EAAOmG,GAEjBC,IACAD,EAAa,GAEbH,EAAOa,KAAK,CAAEC,KAAM,gBAAiBC,KAAM,CAAEpE,IAAKuE,KAiB7B,KAFbvE,EAbDuE,GAeG9E,OAAY,CAAAJ,EAAAE,KAAA,EAAA,KAAA,CAAA,OAAAF,EAAAqB,OAAA,UAAA,KAAA,EAAA,OAAArB,EAAAE,KAAA,GAEdM,EAAeG,EAAKC,EAASkD,EAAQ,CAAEtI,KAAAA,EAAMY,OAAAA,IAAS,KAAA,GAAA,OAAA4D,EAAAqB,OAAA,SAEvD0C,GAAO,KAAA,GAAA,IAAA,MAAA,OAAA/D,EAAAO,OA3BhB,IACQ2E,CA0BQ,GAAA5F,EACf,KAAA,OAAA,SAAAT,GAAA,OAAAH,EAAAX,MAAAkB,KAAAC,UAAA,CAAC,CAjBU,GAkBd,CDlDIiG,CAAsBrB,EAAQC,GCoD3B,SAA6BD,EAAgClC,GAAmD,IAA/CpG,EAAIoG,EAAJpG,KAAMY,EAAMwF,EAANxF,OAAQ4H,EAAMpC,EAANoC,OAC9EoB,EAAcC,EAAerB,GAC/BsB,EAAqC,KACrCC,EAAwC,KAG5C,SAASC,EAAwB/H,EAAoCN,GAEnE,GAAImI,EAAqB,CACvB,IAAM/J,EAAOC,EAAKU,UAAUR,IAAI4J,GAE5B/J,GAAQ4B,EAAMiD,SAAQ7E,EAAKM,QAAQ4J,MAAMC,QAAU,OACvDJ,EAAsB,IACxB,CACA,GAAInI,EAAMiD,OAAQ,CAChB,IAAQlC,EAAST,EAATS,EAAGI,EAAMb,EAANa,EACLqH,EAAWC,SAASC,kBAAkB3H,EAAGI,GACzCpC,EAAYE,EAAOO,WAAWL,QAAO,SAAAiB,GACzC,OAAOuG,EAAOvC,MAAMhE,EAAKlC,GAC3B,IAAGiC,KAAI,SAAAC,GACL,IAAMhC,EAAOC,EAAKU,UAAUR,IAAI6B,EAAKlC,IAErC,IAAKE,EAAM,MAAM,IAAIiC,MAAM,QAE3B,MAAO,CACLD,KAAAA,EACAhC,KAAAA,EAEJ,IASMuK,EAPmBH,EACtBrI,KAAI,SAAAyI,GAAE,OAAI7J,EAAU8J,MAAK,SAAAC,GAAI,OAAIA,EAAK1K,KAAKM,UAAYkK,IAAG,IAC1DzJ,QAAO,SAAC2J,GAAI,OAA8C3E,QAAQ2E,MAGlE3J,QAAO,SAAA2J,GAAI,OAAKA,EAAK1I,KAAKmG,YAEH,GAEtBoC,IACFA,EAAMvK,KAAKM,QAAQ4J,MAAMC,QAAU,MACnCJ,EAAsBQ,EAAMvI,KAAKlC,GAErC,CACF,CAEA2I,EAAOgB,SAAQ,SAAAjB,GACb,GAAqB,gBAAjBA,EAAQe,KAAwB,CAClC,IAAQnE,EAAQoD,EAAQgB,KAAhBpE,IAGRvE,EAAOO,WAAWL,QAAO,SAAAM,GAAC,OAAK+D,EAAIa,SAAS5E,EAAEvB,GAAG,IAAEyB,SAAQ,SAAAS,GACzD,IAAMhC,EAAOC,EAAKU,UAAUR,IAAI6B,EAAKlC,IAEjCE,IAAMA,EAAKM,QAAQ4J,MAAMC,QAAU,MACzC,IACIH,GACFC,EAAwBD,EAAsBH,EAElD,CACA,GAAqB,kBAAjBrB,EAAQe,KAA0B,CACpC,IAAQnE,EAAQoD,EAAQgB,KAAhBpE,IAGRvE,EAAOO,WAAWL,QAAO,SAAAM,GAAC,OAAK+D,EAAIa,SAAS5E,EAAEvB,GAAG,IAAEyB,SAAQ,SAAAS,GACzD,IAAMhC,EAAOC,EAAKU,UAAUR,IAAI6B,EAAKlC,IAEjCE,IAAMA,EAAKM,QAAQ4J,MAAMC,QAAU,GACzC,IACIH,GACFC,EAAwBD,EAAsBH,EAElD,CAQA,MAPqB,gBAAjBrB,EAAQe,MAKVU,EAJAD,EAAuB,CACrBrH,EAAG6F,EAAQgB,KAAKmB,MAAMC,QACtB7H,EAAGyF,EAAQgB,KAAKmB,MAAME,SAEsBhB,GAEzCrB,CACT,GACF,CDrIIoB,CAAyBrB,EAAQC,GAErC,gDE6BasC,WAAYC,GAWvB,SAAAD,EAAY/K,GAAe,IAAAiL,EAUgB,mGAVhBC,MAAAH,GACVI,EAAfF,EAAAG,EAAAL,KAAAA,GAAM,WAAS,UAHG,IAIlBE,EAAK/G,SAAUlE,aAAAA,EAAAA,EAAOkE,UAAY,WAAA,MAAO,CACvCnB,IAAK,GACLT,KAAM,GACNO,MAAO,GACPI,OAAQ,KAEVgI,EAAKpG,SAAU7E,aAAAA,EAAAA,EAAO6E,UAAY,WAAA,OAAM,GACxCoG,EAAK9H,MAAOnD,aAAAA,EAAAA,EAAOmD,OAAS,SAACpD,EAAIoD,GAAI,OAAKA,GAC1C8H,EAAKhF,OAAQjG,aAAAA,EAAAA,EAAOiG,QAAU,WAAA,OAAM,GAAKgF,CAC3C,CAEA,4RAAAI,CAAAN,EAAAC,KAAAD,IAAA,CAAA,CAAAO,IAAA,YAAAvE,MACA,SAAUwE,GAAwD,IAAAC,EAAA7H,KAChE8H,EAAAC,EAAAX,EAAAY,WAAA,YAAAhI,MAAAiI,KAAAjI,KAAgB4H,GAEhB5H,KAAKzD,KAAOyD,KAAKkI,YAAwCC,EAAcA,gBACvEnI,KAAK7C,OAAS6C,KAAKzD,KAAK2L,YAAiCE,EAAUA,YAEnE,IAAM/L,EAAQ,CAAEc,OAAQ6C,KAAK7C,OAAQZ,KAAMyD,KAAKzD,MACxCgE,EAAkCP,KAAlCO,QAASf,EAAyBQ,KAAzBR,KAAM0B,EAAmBlB,KAAnBkB,QAASoB,EAAUtC,KAAVsC,MAC1B6D,EAAcC,EAAepG,MACnCqI,EH1CG,SAA6BhM,GAIlC,IAAMiM,EAAS,IAAIC,IACbC,EAAY,SAACpM,GAAU,OAAKkM,EAAOG,IAAIrM,GAAKkM,EAAO7L,IAAIL,IAAO,GAAK,EAAE,EACrEsM,EAAY,SAACtM,GAAU,OAAKkM,EAAOG,IAAIrM,GAAKkM,EAAO7L,IAAIL,IAAO,GAAK,EAAE,EAE3E,MAAO,CACCgF,mBAAUhF,EAAI6C,EAAGI,GAAG,OAAAa,EAAAC,IAAAC,eAAAC,IAAA,IAAA/D,EAAAyH,EAAA,OAAA5D,IAAAW,MAAA,SAAAC,GAAA,cAAAA,EAAAC,KAAAD,EAAAE,MAAA,KAAA,EACiB,GAAnC3E,EAAOD,EAAME,KAAKU,UAAUR,IAAIL,GAE7B,CAAA2E,EAAAE,KAAA,EAAA,KAAA,CAAA,MAAQ,IAAI1C,MAAM,gCAA+B,KAAA,EAE5B,IAAxBwF,EAAWzH,EAAKkC,UAETS,IAAMA,GAAK8E,EAAS1E,IAAMA,EAAC,CAAA0B,EAAAE,KAAA,EAAA,KAAA,CACzB,OAAbuH,EAAUpM,GAAG2E,EAAAE,KAAA,EACP3E,EAAK8E,UAAUnC,EAAGI,GAAE,KAAA,EAC1BqJ,EAAUtM,GAAG,KAAA,EAAA,IAAA,MAAA,OAAA2E,EAAAO,OAAA,GAAAjB,EAAA,IAVSH,EAYzB,EACDyI,cAAa,SAACvM,GACZ,OAAQkM,EAAO7L,IAAIL,IAAO,GAAK,CACjC,EAEJ,CGgByCwM,CAAiBvM,GAA9C+E,EAASiH,EAATjH,UAAWuH,EAAaN,EAAbM,cACbrI,EAAc,CAAEC,QAAAA,EAASf,KAAAA,EAAM0B,QAAAA,EAASoB,MAAAA,EAAOlB,UAAAA,ICzElD,SAAyB/E,GAC9B,IJyD4Bc,EACxB0L,EI1DEC,GJyDsB3L,EIzDKd,EAAMc,OJ0DnC0L,GAAQ,EAEZ1L,EAAO4I,SAAQ,SAAAjB,GAOb,MANqB,UAAjBA,EAAQe,OACVgD,GAAQ,GAEW,YAAjB/D,EAAQe,MAAuC,mBAAjBf,EAAQe,OACxCgD,GAAQ,GAEH/D,CACT,IAEO,WAAA,OAAM+D,CAAK,GInElBxM,EAAME,KAAKwJ,SAAQ,SAAAjB,GACjB,IAAKA,GAAgC,WAAnBiE,EAAOjE,MAAwB,SAAUA,GAAU,OAAOA,EAC5E,GAAqB,eAAjBA,EAAQe,KAAuB,CACjC,IAAMmD,EAAWlE,EAAQgB,KAAKlI,OAE9B,GAAIoL,IACa3M,EAAMc,OAAOO,WAAWqJ,MAAK,SAAApJ,GAAC,OAAIA,EAAEvB,KAAO4M,KAE7C,MAAM,IAAIzK,MAAM,2BAEjC,CACA,GAAqB,eAAjBuG,EAAQe,OAA0BiD,IAAc,CAClD,IAAQ1M,EAAO0I,EAAQgB,KAAf1J,GAIR,GAFcC,EAAMc,OAAOO,WAAWqJ,MAAK,SAAApJ,GAAC,OAAIA,EAAEC,SAAWxB,KAElD,MAAM,IAAImC,MAAM,4CAC7B,CACA,OAAOuG,CACT,GACF,CDmDImE,CAAa5M,GNtCV,SAAwBA,GAE7BA,EAAME,KAAKwJ,QAAO,WAAA,IAAA5H,EAAA+B,EAAAC,IAAAC,MAAC,SAAAC,EAAMyE,GAAO,IAAA1I,EAAA0B,EAAA,OAAAqC,IAAAW,MAAA,SAAAC,GAAA,cAAAA,EAAAC,KAAAD,EAAAE,MAAA,KAAA,EAAA,GACxB6D,aAAmBkB,QAAa,SAAUlB,EAAQ,CAAA/D,EAAAE,KAAA,EAAA,KAAA,CAAA,OAAAF,EAAAqB,OAAA,SAAS0C,GAAO,KAAA,EAGvE,GAFoB,eAAjBA,EAAQe,MACV9I,EAAa+H,EAAQgB,KAAK1J,GAAIC,GAEX,sBAAjByI,EAAQe,KAA4B,CAAA9E,EAAAE,KAAA,GAAA,KAAA,CAEW,GADzC7E,EAAO0I,EAAQgB,KAAf1J,GACF0B,EAAazB,EAAMc,OAAO+L,cAAc9M,GAE/B,CAAA2E,EAAAE,KAAA,EAAA,KAAA,CAAA,MAAQ,IAAI1C,MAAM,0BAAyB,KAAA,EAC1DpC,EAAoB2I,EAAQgB,KAAK1J,GAAIC,GACrCU,EAAae,EAAWP,OAAQlB,GAChCU,EAAae,EAAWN,OAAQnB,GAAM,KAAA,GAAA,OAAA0E,EAAAqB,OAAA,SAEjC0C,GAAO,KAAA,GAAA,IAAA,MAAA,OAAA/D,EAAAO,OAAA,GAAAjB,EACf,KAAA,OAAA,SAAAT,GAAA,OAAAzB,EAAAW,MAAAkB,KAAAC,UAAA,CAAC,CAfgB,GAgBpB,CMqBIkJ,CAAY9M,GAEZ2D,KAAKoJ,QAAQvL,SAAQ,SAAAwL,GACnBA,EAAO/I,EAAWgJ,EAAAA,KAAOjN,GAAK,GAAA,CAAE0I,OAAQ8C,IAC1C,IAGA7H,KAAK+F,QAAO,WAAA,IAAA5H,EAAA+B,EAAAC,IAAAC,MAAC,SAAAC,EAAMyE,GAAO,IAAAyE,EAAAC,EAAA5L,EAAA6L,EAAAC,EAAAV,EAAAW,EAAA,OAAAxJ,IAAAW,MAAA,SAAAC,GAAA,cAAAA,EAAAC,KAAAD,EAAAE,MAAA,KAAA,EAAA,GACH,mBAAjB6D,EAAQe,KAAyB,CAAA9E,EAAAE,KAAA,GAAA,KAAA,CAEK,GADhC7E,EAAO0I,EAAQgB,KAAf1J,GACFoN,EAAUnN,EAAMc,OAAOkE,QAAQjF,GAEzB,CAAA2E,EAAAE,KAAA,EAAA,KAAA,CAAA,MAAQ,IAAI1C,MAAM,oBAAmB,KAAA,EAAA,GAG5CoK,EAAcvM,GAAG,CAAA2E,EAAAE,KAAA,EAAA,KAAA,CAAA,OAAAF,EAAAE,KAAA,EACdwC,EAAkBrH,EAAI0I,EAAQgB,KAAMzJ,GAAM,KAAA,EAGyB,KAArEuB,EAAS4L,EAAQ5L,OAASvB,EAAMc,OAAOkE,QAAQmI,EAAQ5L,QAAU,OAExD0C,EAAYY,QAAQ9E,GAAG,CAAA2E,EAAAE,KAAA,GAAA,KAAA,CAEsB,GADpDwI,EAAuB7E,EAAkBxI,EAAIC,GAC7CqN,EAAW/E,EAAU6E,EAAQpN,GAAI+J,EAAa9J,GAE/CoN,GAAyBC,EAAQ,CAAA3I,EAAAE,KAAA,GAAA,KAAA,CAAA,OAAAF,EAAAE,KAAA,GAC9BtB,EAAa/B,EAAQ0C,EAAajE,GAAM,KAAA,GAAA,GAI/B,gBAAjByI,EAAQe,KAAsB,CAAA9E,EAAAE,KAAA,GAAA,KAAA,CAEyB,GADnD+H,EAAWlE,EAAQgB,KAAKlI,SACxBA,EAASoL,GAAY3M,EAAMc,OAAOkE,QAAQ2H,IAEtC,CAAAjI,EAAAE,KAAA,GAAA,KAAA,CAAA,OAAAF,EAAAE,KAAA,GACFtB,EAAa/B,EAAQ0C,EAAajE,GAAM,KAAA,GAAA,OAAA0E,EAAAqB,OAAA,SAG3C0C,GAAO,KAAA,GAAA,IAAA,MAAA,OAAA/D,EAAAO,OAAA,GAAAjB,EACf,KAAA,OAAA,SAAAT,GAAA,OAAAzB,EAAAW,MAAAkB,KAAAC,UAAA,CAAC,CAhCU,GAiCd,GAEA,CAAA0H,IAAA,YAAAvE,MAIA,SAAiBiG,GACfrJ,KAAKoJ,QAAQzD,KAAK0D,EACpB,GAAC,CAAA1B,IAAA,cAAAvE,MAED,SAAmBhH,GACjB,IAAMC,EAAQ,CAAEc,OAAQ6C,KAAK7C,OAAQZ,KAAMyD,KAAKzD,MAC1C+B,EAAO0B,KAAK7C,OAAOkE,QAAQjF,GAEjC,OAAOkC,IAASA,EAAKmG,UAAYG,EAAkBxI,EAAIC,GACzD,gGAAC,EA3FOuN,SA8FH,SAASxD,EAAyCrB,GACvD,IAAM7G,EAAkB,GAYxB,OAVA6G,EAAOgB,QAAO,WAAA,IAAAtG,EAAAS,EAAAC,IAAAC,MAAC,SAAAgE,EAAMU,GAAO,OAAA3E,IAAAW,MAAA,SAAA0D,GAAA,cAAAA,EAAAxD,KAAAwD,EAAAvD,MAAA,KAAA,EAAA,GACpB,SAAU6D,EAAO,CAAAN,EAAAvD,KAAA,EAAA,KAAA,CAAA,OAAAuD,EAAApC,OAAA,SAAU0C,GAAO,KAAA,EAMvC,MALoB,gBAAjBA,EAAQe,MACV3H,EAAMyH,KAAI7G,MAAVZ,EAAKa,EAAS+F,EAAQgB,KAAKpE,MAER,kBAAjBoD,EAAQe,MACV3H,EAAM2L,OAAM/K,MAAZZ,EAAK,CAAQ,EAAGA,EAAMiD,QAAM2I,OAAA/K,EAAKb,EAAMb,QAAO,SAAAjB,GAAE,OAAK0I,EAAQgB,KAAKpE,IAAIa,SAASnG,EAAG,OACnFoI,EAAApC,OAAA,SACM0C,GAAO,KAAA,EAAA,IAAA,MAAA,OAAAN,EAAAlD,OAAA,GAAA8C,EACf,KAAA,OAAA,SAAAvE,GAAA,OAAAJ,EAAAX,MAAAkB,KAAAC,UAAA,CAAC,CATY,IAUP/B,CACT"}